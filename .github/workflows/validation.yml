name: ci-validation

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validation:
    runs-on: ubuntu-latest
    env:
      UV_PROJECT_ENVIRONMENT: ${{ github.workspace }}/.venv
      UV_LINK_MODE: copy
      UV_COMPILE_BYTECODE: "1"
      UV_CACHE_DIR: ./.uv-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # paths-filter requires the base ref to detect docs-only changes correctly
          fetch-depth: 0

      - name: Detect docs-only changes
        id: docs-filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - '**/*.md'
            code:
              - '**'
              - '!**/*.md'

      - name: Determine if validation can be skipped
        id: skip-check
        run: |
          docs="${{ steps.docs-filter.outputs.docs }}"
          code="${{ steps.docs-filter.outputs.code }}"
          if [[ "$docs" == "true" && "$code" != "true" ]]; then
            echo "only_docs=true" >> "$GITHUB_OUTPUT"
            echo "Docs-only change detected; skipping validation. âœ…"
          else
            echo "only_docs=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Docs-only summary
        if: ${{ steps.skip-check.outputs.only_docs == 'true' }}
        run: echo "Documentation-only update; no validation run required."

      - name: Prepare container-style paths
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        run: |
          if [ -e /app ]; then
            sudo rm -rf /app
          fi
          sudo ln -s "$GITHUB_WORKSPACE" /app
          sudo mkdir -p /app/system /app/data
          sudo chown -R "$USER":"$USER" /app/system /app/data

      - name: Set up Python
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Seed validation secrets
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        run: |
          python scripts/seed_ci_secrets.py --output system/secrets.yaml
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          LIBRECHAT_API_KEY: ${{ secrets.LIBRECHAT_API_KEY }}

      - name: Verify seeded secrets file
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        run: |
          if [ ! -f system/secrets.yaml ]; then
            echo "system/secrets.yaml missing"
            exit 1
          fi
          python - <<'PY'
          from pathlib import Path

          path = Path("system/secrets.yaml")
          keys = []
          if path.exists():
              for line in path.read_text().splitlines():
                  if ":" in line:
                      key = line.split(":", 1)[0].strip()
                      if key:
                          keys.append(key)
          print("System secrets keys:", sorted(keys))
          PY

      - name: Install uv
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        uses: astral-sh/setup-uv@v2

      - name: Sync dependencies
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        working-directory: docker
        env:
          UV_PROJECT_ENVIRONMENT: ${{ env.UV_PROJECT_ENVIRONMENT }}
        run: uv sync --frozen --all-extras --no-install-project

      - name: Run validation scenarios (integration suite)
        if: ${{ steps.skip-check.outputs.only_docs != 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          LIBRECHAT_API_KEY: ${{ secrets.LIBRECHAT_API_KEY }}
        run: |
          ${{ env.UV_PROJECT_ENVIRONMENT }}/bin/python validation/run_validation.py run integration

      - name: Upload validation artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: validation-runs
          path: validation/runs
